<!DOCTYPE html>
<html lang="ru">
<head>
  <script>
function searchByNickname() {
  const input = document.getElementById("scroll-nick");
  const query = input ? input.value.trim().toLowerCase() : "";
  if (!query) return;
  const rows = document.querySelectorAll('tr[data-nickname]');
  let found = false;
  for (const row of rows) {
    if (row.dataset.nickname === query) {
      row.scrollIntoView({ behavior: 'smooth', block: 'center' });
      row.style.outline = '2px solid gold';
      setTimeout(() => row.style.outline = '', 3000);
      found = true;
      break;
    }
  }
  if (!found) alert("–ò–≥—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω.");
}
function handleEnterKey(event) {
  if (event.key === "Enter") {
    event.preventDefault();
    searchByNickname();
  }
}

    if (localStorage.getItem('theme') === 'dark') {
      document.documentElement.classList.add('dark');
    } else {
      document.documentElement.classList.remove('dark');
    }
  </script>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="UTF-8">
  <title>For Glory!</title>
  <link rel="icon" href="{{ url_for('static', filename='icons/favicon.png') }}" type="image/x-icon">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <div class="container">
    <form method="POST" class="form-container">
      <div class="mode-toggle">
        <input type="radio" id="tab1" name="mode" value="–û–±—â–∏–π"
               onchange="this.form.submit()" {{ 'checked' if mode == '–û–±—â–∏–π' else '' }}>
        <label for="tab1">–û–±—â–∏–π</label>

        <input type="radio" id="tab2" name="mode" value="–ü—Ä–∏—Ä–æ—Å—Ç"
               onchange="this.form.submit()" {{ 'checked' if mode == '–ü—Ä–∏—Ä–æ—Å—Ç' else '' }}>
        <label for="tab2">–ü—Ä–∏—Ä–æ—Å—Ç</label>

        <input type="radio" id="tab3" name="mode" value="–õ—É—á—à–∏–µ (–ø—Ä–∏—Ä–æ—Å—Ç—ã)"
               onchange="this.form.submit()" {{ 'checked' if mode == '–õ—É—á—à–∏–µ (–ø—Ä–∏—Ä–æ—Å—Ç—ã)' else '' }}>
        <label for="tab3" class="tab-two-line"
			   style="display:inline-flex;flex-direction:column;align-items:center;line-height:1.1;">
		  <span class="tab-main">–õ—É—á—à–∏–µ</span>
		  <span class="tab-sub" style="font-size:12px;opacity:.85;margin-top:-2px;display:block;">–ø—Ä–∏—Ä–æ—Å—Ç—ã</span>
		</label>
      </div>

      <div class="date-select">
        {% if mode == '–ü—Ä–∏—Ä–æ—Å—Ç' %}
          <div class="row-inline">
            <label>–æ—Ç</label>
            <select name="file1" onchange="this.form.submit()">
              {% for f in json_files %}
                <option value="{{ f }}" {% if f == file1 %}selected{% endif %}>
                  {{ extract_datetime_from_filename(f).strftime('%d.%m.%Y %H:%M') }}
                </option>
              {% endfor %}
            </select>
            <label>–¥–æ</label>
            <select name="file2" onchange="this.form.submit()">
              {% for f in json_files %}
                <option value="{{ f }}" {% if f == file2 %}selected{% endif %}>
                  {{ extract_datetime_from_filename(f).strftime('%d.%m.%Y %H:%M') }}
                </option>
              {% endfor %}
            </select>
          </div>
        {% elif mode == '–õ—É—á—à–∏–µ (–ø—Ä–∏—Ä–æ—Å—Ç—ã)' %}
          <!-- –í—ã–±–æ—Ä –¥–∞—Ç —Å–∫—Ä—ã—Ç -->
        {% else %}
          <select name="file" onchange="this.form.submit()">
            {% for f in json_files %}
              <option value="{{ f }}" {% if f == selected_file %}selected{% endif %}>
                {{ extract_datetime_from_filename(f).strftime('%d.%m.%Y %H:%M') }}
              </option>
            {% endfor %}
          </select>
        {% endif %}
      </div>

      {% if mode != '–õ—É—á—à–∏–µ (–ø—Ä–∏—Ä–æ—Å—Ç—ã)' %}
        {% if diff_hours %}
          <div style="font-size: 0.9em; color: #888; margin-top: -5px; margin-bottom: 6px;">
            ({% if mode == '–û–±—â–∏–π' %}+{% endif %}–ø—Ä–∏—Ä–æ—Å—Ç –∑–∞ {{ diff_hours }}
            {{
              ' —á–∞—Å' if diff_hours % 10 == 1 and diff_hours % 100 != 11 else
              ' —á–∞—Å–∞' if diff_hours % 10 in [2,3,4] and diff_hours % 100 not in [12,13,14] else
              ' —á–∞—Å–æ–≤'
            }})
          </div>
        {% endif %}
      {% endif %}

      <div class="controls-row row-inline">
        <select name="param" onchange="this.form.submit()">
          {% for p in param_selectable %}
            <option value="{{ p }}" {% if p == param %}selected{% endif %}>{{ p }}</option>
          {% endfor %}
        </select>
      </div>
		{% if not (param == "–ü–æ —É—Ä–æ–≤–Ω—é" or param.startswith("–ë—Ä–∞—Ç—Å—Ç–≤–∞") or param.startswith("–ö–ª–∞–Ω—ã")) %}
				<div class="filter-row search-row">
				  <input type="text" id="scroll-nick" list="nicknames" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∏–∫—É"
						 class="search-input"
						 onkeydown="handleEnterKey(event)">
				  <datalist id="nicknames"></datalist>
				  <button type="button" onclick="searchByNickname()" class="search-btn">üîç</button>
				</div>

		
				<div class="controls-row row-inline" style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
				  <label for="level-select" style="white-space: nowrap;">–£—Ä–æ–≤–µ–Ω—å:</label>
				  <select name="level" id="level-select" onchange="this.form.submit()" style="padding: 4px 6px;">
					<option value="–í—Å–µ"
					  {% if selected_level is not defined
							or selected_level is none
							or selected_level == ''
							or selected_level == '–í—Å–µ' %}selected{% endif %}>
					  –í—Å–µ
					</option>
					{% for lvl in all_levels|reverse %}
					  <option value="{{ lvl }}"
						{% if selected_level is defined and (selected_level|string) == (lvl|string) %}selected{% endif %}>
						{{ lvl }}
					  </option>
					{% endfor %}
				  </select>
				</div>
		{% endif %}

    </form>

    <button id="theme-toggle" class="theme-toggle"
            style="position: absolute; right: 0; top: 0; font-size: 24px;">
      üåô
    </button>

    {% if mode == '–õ—É—á—à–∏–µ (–ø—Ä–∏—Ä–æ—Å—Ç—ã)' %}
		  <div style="font-size:0.7em; color:#666; margin:4px 0 10px;">
			<p>
			  –õ—É—á—à–∏–µ —Å—É—Ç–æ—á–Ω—ã–µ –ø—Ä–∏—Ä–æ—Å—Ç—ã –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ {{ 30 }} –¥–Ω–µ–π.<br>
			  –ü—Ä–æ–ø—É—Å–∫–∏ –±–æ–ª–µ–µ 26&nbsp;—á–∞—Å–æ–≤ –Ω–µ —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è.
			</p>
		  </div>
	
      {% set blocks = best_by_param | selectattr('param', 'equalto', param) | list %}
      {% set block = blocks[0] if blocks|length > 0 else None %}
      {% if block and block.rating and block.rating|length > 0 %}
        <table class="rating-table">
          <thead>
            <tr>
              <th style="width:40px; text-align:center;">‚Ññ</th>
              <th style="text-align:left;">–ò–≥—Ä–æ–∫</th>
              <th style="text-align:left;">{{ block.param }}</th>
            </tr>
          </thead>
          <tbody>
            {% for row in block.rating[:1000] %}
              <tr data-nickname="{{ row[1]|lower }}">
                <td style="width:40px; text-align:center;">{% if loop.index == 1 %}ü•á{% elif loop.index == 2 %}ü•à{% elif loop.index == 3 %}ü•â{% else %}{{ loop.index }}{% endif %}</td>
                <td style="text-align:left;">
					<a href="https://playwekings.mobi/hero/detail?player={{ row[0] }}" target="_blank"
					   style="display:inline-flex; width:100%; overflow:hidden; min-width:0; align-items:baseline;">
					  <span style="min-width:0; max-width:18ch; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; display:block;">
						{{ row[1] }}
					  </span>
					  <span style="margin-left:6px; font-size:0.75em; position:relative; top:-0.45em;">
						{{ row[2] }}
					  </span>
					</a>
                </td>
					<td style="text-align:left;">
					  {{ row[3] }}
					  {% if row[4] %}
						<sup style="font-size:0.6em; margin-left:2px; opacity:.7">
						  {{ extract_datetime_from_filename(row[4]).strftime('%d.%m') }}
						</sup>
					  {% endif %}
					</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <div style="opacity:.7;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ ¬´{{ param }}¬ª.</div>
      {% endif %}
    {% endif %}

    {% if param == "–ü–æ —É—Ä–æ–≤–Ω—é" and mode == "–û–±—â–∏–π" %}
		<div style="margin:8px 0 6px; font-weight:600;">
		  –í—Å–µ–≥–æ {{ totals.count }} {% if totals.delta %}
			<span style="font-size:0.75em; position:relative; top:-0.45em; color: {{ 'green' if totals.delta > 0 else 'red' }};">
			  {% if totals.delta > 0 %}+{{ totals.delta }}{% else %}{{ totals.delta }}{% endif %}
			</span>
		  {% endif %}
		   –∏–≥—Ä–æ–∫–æ–≤
		</div>
      <tbody>
        {% for group in level_ratings %}
        <tr>
          <td colspan="3">
            <details>
				{% set d = group.count_delta if group.count_delta is defined else 0 %}
				<summary>–£—Ä–æ–≤–µ–Ω—å {{ group.level }} [{{ group.count }}{% if d %}<span style="margin-left:4px;font-size:0.75em;position:relative;top:-0.45em;color:{{ 'green' if d > 0 else 'red' }};">{% if d > 0 %}+{{ d }}{% else %}{{ d }}{% endif %}</span>{% endif %}]</summary>

              <div class="details">
                <table class="inner-table" style="table-layout:auto; width:100%; max-width:480px; font-size:0.8em;">
                  <thead>
					  <tr>
						<th style="text-align:center;">‚Ññ</th>
						<th class="wide-name" style="text-align:left;">–ù–∏–∫</th>
						<th class="tight" style="text-align:center;"><img src="{{ url_for('static', filename='icons/strength.png') }}" alt="strength" class="icon"></th>
						<th class="tight" style="text-align:center;"><img src="{{ url_for('static', filename='icons/defense.png') }}" alt="defense" class="icon"></th>
						<th class="tight" style="text-align:center;"><img src="{{ url_for('static', filename='icons/dexterity.png') }}" alt="dexterity" class="icon"></th>
						<th class="tight" style="text-align:center;"><img src="{{ url_for('static', filename='icons/mastery.png') }}" alt="mastery" class="icon"></th>
						<th class="tight" style="text-align:center;"><img src="{{ url_for('static', filename='icons/vitality.png') }}" alt="vitality" class="icon"></th>
					  </tr>
					</thead>
					
					{% set b = (balance_map.get(group.level) if balance_map is defined else None) %}
					{% if b and b.stats %}
					  <tbody>
						<tr>
						  <td class="tight" style="text-align:center;">‚öñ</td>

							<td class="wide-name" style="text-align:left; font-weight:600; white-space:nowrap;">
							  <span style="display:flex; width:100%; align-items:center; gap:8px;">
									<span>–ë–∞–ª–∞–Ω—Å</span>

									<span style="margin-left:auto; font-weight:400; font-size:0.9em; line-height:1.15;padding-right:4px; text-align:right; white-space:normal;">
									<span style="display:block;">—Å—Ä. {{ group.level - 1 }} —É—Ä.√ó1.15</span>
									<span style="display:block;">–º–∞–∫—Å. {{ group.level }} —É—Ä.√ó0.75</span>
								</span>
							  </span>
							</td>
							
						  {% for key in ['strength','defense','dexterity','mastery','vitality'] %}
							{% set s = b.stats[key] %}
							<td class="tight" style="text-align:center; white-space:nowrap; line-height:1.15;">
							  <span style="display:block">{{ s.upper15 }}</span>
							  <span style="display:block;">{{ s.cap75 }}</span>
							</td>
						  {% endfor %}
						</tr>

						{% if b.count < 20 %}
						  <tr>
							<td></td>
							<td colspan="6" style="text-align:left; padding:4px 0; font-size:0.8em;">
							  –ë–∞–ª–∞–Ω—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: –Ω–∞ —É—Ä–æ–≤–Ω–µ {{ b.count }}<20 –∏–≥—Ä–æ–∫–æ–≤.
							</td>
						  </tr>
						{% endif %}
					  </tbody>
					{% endif %}


					<tbody id="lvl-{{ group.level }}-tbody"
						   data-snapshot="{{ file }}"
						   data-level="{{ group.level }}"
						   data-page="0">
					</tbody>

                </table>

                <div class="level-controls" style="margin-top:8px; display:flex; gap:8px; align-items:center;">
					<button type="button"
							class="load-more-btn"
							data-level="{{ group.level }}"
							style="padding:6px 10px; border-radius:8px; border:1px solid #999;
								   background:rgba(255,255,255,.06);
								   color:#cfcfcf;
								   cursor:pointer; display:none;">
					  –ü–æ–∫–∞–∑–∞—Ç—å –µ—â—ë
					</button>
                  <span class="load-status" data-level="{{ group.level }}" style="opacity:.85; color:#bdbdbd;"></span>

                </div>
              </div>
            </details>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    {% endif %}

    {% if mode != '–õ—É—á—à–∏–µ (–ø—Ä–∏—Ä–æ—Å—Ç—ã)' %}
      <table class="rating-table">
        <thead>
          {% if param != "–ü–æ —É—Ä–æ–≤–Ω—é" %}
          <tr>
            <th style="width:40px; text-align:center;">‚Ññ</th>
            <th style="text-align:left;">{{ column2_name }}</th>
            <th class="tight" style="text-align:left;">{{ column3_name }}</th>
          </tr>
          {% endif %}
        </thead>
        <tbody>
          {% if param.startswith('–ö–ª–∞–Ω—ã') or param.startswith('–ë—Ä–∞—Ç—Å—Ç–≤–∞') %}
            {% for idx, row in enumerate(rating, 1) %}
              <tr>
                <td style="text-align:center; padding:0 6px; white-space:nowrap;">{% if idx == 1 %}ü•á{% elif idx == 2 %}ü•à{% elif idx == 3 %}ü•â{% else %}{{ idx }}{% endif %}</td>
                <td>
                  <details>
					<summary style="display:inline-flex; width:100%; overflow:hidden; align-items:baseline;">
					  <span style="
							min-width:0;
							max-width:20ch;
							white-space:nowrap;
							overflow:hidden;
							text-overflow:ellipsis;
							display:inline-block;
						  ">
						{{ row.name }}&nbsp;
					  </span>

					  <span style="white-space:nowrap;">
						[{{ row.members|length }}{% if row.count_delta and row.count_delta != 0 %}
						  <span style="font-size:0.75em; position:relative; top:-0.45em; color: {{ 'green' if row.count_delta > 0 else 'red' }};">
							{% if row.count_delta > 0 %}+{{ row.count_delta }}{% else %}{{ row.count_delta }}{% endif %}
						  </span>
						{% endif %}]
					  </span>
					</summary>

					
                    <div class="details">
                      <table class="inner-table" style="table-layout: auto; width: 100%; font-size:0.8em">
						  <colgroup>
							<col style="width:auto;">
							<col style="width:52%;">
							<col style="width:auto;">
						  </colgroup>
						{% for hero in row.members %}
						  {% set hname  = hero.get('–ò–º—è') or hero.get('name') %}
						  {% set hid    = hero.get('ID')  or hero.get('id')  or hero.get('pid') %}
						  {% set hlevel = hero.get('–£—Ä–æ–≤–µ–Ω—å') or hero.get('level') %}
						  {% set hscore = hero.get('value') %}
						  {% set hrank  = hero.get('_rank', loop.index) %}
						  {% set hdelta = hero.get('delta') %}

							<tr data-nickname="{{ (hname or '')|lower|e }}">
							  <td style="text-align:left;">{{ hrank }}</td>

							  <td style="width:auto">
								<a href="https://playwekings.mobi/hero/detail?player={{ hid }}" target="_blank"
								   style="display:inline-flex; width:100%; overflow:hidden; min-width:0; flex-wrap:nowrap; white-space:nowrap; align-items:center;">
								  <span style="min-width:0; max-width:15ch; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; display:block;">
									{{ hname }}
								  </span>
								  <span style="white-space:nowrap; font-size:0.75em; display:inline-block; transform:translateY(-0.35em); line-height:1;">
									{{ hlevel }}
								  </span>
								</a>

							  </td>

							  <td class="tight" style="text-align:left; padding-left:5px; flex-wrap:nowrap; white-space:nowrap">
								{{ hscore }}
								{% if hdelta is not none and hdelta != 0 %}
								  <sup style="color: {{ 'green' if hdelta > 0 else 'red' }}; font-size:0.8em;">
									{% if hdelta > 0 %}+{{ hdelta }}{% elif hdelta < 0 %}{{ hdelta }}{% endif %}
								  </sup>
								{% endif %}
							  </td>
							</tr>

						{% endfor %}
                      </table>
                    </div>
                  </details>
                </td>
				
				<td class="tight" style="text-align:left; padding-left:4px; white-space:nowrap;">
				  {% set rdelta = row.get('delta') %}
				  {{ row.score }}{% if rdelta is not none and rdelta != 0 %}<span style="font-size:0.75em; display:inline-block; transform:translateY(-0.35em); line-height:1; color: {{ 'green' if rdelta > 0 else 'red' }};">{% if rdelta > 0 %}+{{ rdelta }}{% else %}{{ rdelta }}{% endif %}</span>{% endif %}
				</td>

              </tr>
            {% endfor %}
          {% else %}
            {% for idx, row in enumerate(rating, 1) %}
				{% set ID = row[0] %}
				{% set name = row[1] %}
				{% set level = row[2] %}
				{% set value = row[3] %}
		
              <tr data-nickname="{{ name|lower|e }}" {% if highlighted %}style="background: rgba(255,215,0,0.2);"{% endif %}>
                <td style="width:30px; text-align:center;">{% if idx == 1 %}ü•á{% elif idx == 2 %}ü•à{% elif idx == 3 %}ü•â{% else %}{{ idx }}{% endif %}</td>
                <td class="wide-name">
					<a href="https://playwekings.mobi/hero/detail?player={{ ID }}" target="_blank"
					   style="display:inline-flex; width:100%; overflow:hidden; min-width:0; align-items:baseline;">
					  <span style="min-width:0; max-width:15ch; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; display:block;">
						{{ name }}
					  </span>
					<span style="white-space:nowrap; font-size:0.75em; display:inline-block; transform:translateY(-0.35em); line-height:1;">
					  {{ level }}
					</span>
					</a>
                </td>
				<td style="text-align:left;">
				  {{ value }}
				  {% if mode == "–û–±—â–∏–π" and row[4] is not none and row[4] != 0 %}
					<span style="color: {{ 'green' if row[4] > 0 else 'red' }}; font-size:0.75em; display:inline-block; transform:translateY(-0.35em); line-height:1;">
					  {{ '+' if row[4] > 0 else '-' }}{{ row[4] }}
					</span>
				  {% endif %}
				  {% if mode != "–û–±—â–∏–π" and row[4] is not none %}
					<span style="color:#888; font-size:0.75em; display:inline-block; transform:translateY(-0.35em); line-height:1;">
					  {{ row[4] }} ‚öî
					</span>
				  {% endif %}
				</td>
              </tr>
            {% endfor %}
          {% endif %}
        </tbody>
      </table>
    {% endif %}
  </div>
  
  <script>
	  function toggleHelp(btn, id) {
		const el = document.getElementById(id);
		const isOpen = el.style.display !== 'none';

		// –ó–∞–∫—Ä—ã—Ç—å –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏
		document.querySelectorAll('[id^="bal_"]').forEach(x => { x.style.display = 'none'; });

		// –û—Ç–∫—Ä—ã—Ç—å/–∑–∞–∫—Ä—ã—Ç—å —Ç–µ–∫—É—â—É—é
		el.style.display = isOpen ? 'none' : 'block';
		btn.setAttribute('aria-expanded', isOpen ? 'false' : 'true');
	  }

	  // –ó–∞–∫—Ä—ã–≤–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫–∏ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ
	  document.addEventListener('click', function (e) {
		const isHelp = e.target.closest && e.target.closest('button[aria-controls^="bal_"], span[id^="bal_"]');
		if (!isHelp) {
		  document.querySelectorAll('[id^="bal_"]').forEach(x => { x.style.display = 'none'; });
		  document.querySelectorAll('button[aria-controls^="bal_"]').forEach(b => b.setAttribute('aria-expanded', 'false'));
		}
	  });
	</script>


  <script>
	  // –°–±–æ—Ä –Ω–∏–∫–Ω–µ–π–º–æ–≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ (–±–µ–∑ –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö if/else –≤–Ω—É—Ç—Ä–∏ JS-–º–∞—Å—Å–∏–≤–∞)
	  {% set names_list = [] %}
	  {% if mode == '–õ—É—á—à–∏–µ (–ø—Ä–∏—Ä–æ—Å—Ç—ã)' %}
		{% set blocks = best_by_param | selectattr('param','equalto',param) | list %}
		{% if blocks|length > 0 %}
		  {% set names_list = (blocks[0].rating[:1000] | map(attribute=1) | list) %}
		{% endif %}
	  {% else %}
		{% set ns = namespace(names=[]) %}
		{% for row in rating %}
		  {# –°–ª–æ–≤–∞—Ä—å (–∫–ª–∞–Ω—ã/–±—Ä–∞—Ç—Å—Ç–≤–∞ –∏ —Ç.–ø.) #}
		  {% if row is mapping %}
			{% set rname = row.get('name') %}
			{% if rname is not none %}
			  {% set ns.names = ns.names + [rname] %}
			{% endif %}
			{% if row.get('members') %}
			  {% for hero in row.get('members') %}
				{% if hero is mapping and hero.get('name') is not none %}
				  {% set ns.names = ns.names + [hero.get('name')] %}
				{% endif %}
			  {% endfor %}
			{% endif %}
		  {# –ö–æ—Ä—Ç–µ–∂/—Å–ø–∏—Å–æ–∫ (pid, name, ...) #}
		  {% elif row is sequence and row|length > 1 %}
			{% set ns.names = ns.names + [row[1]] %}
		  {% endif %}
		{% endfor %}
		{% set names_list = ns.names %}
	  {% endif %}
	  const allNicknames = {{ names_list | tojson }};

	  document.addEventListener("DOMContentLoaded", () => {
		// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–µ–º—ã
		const toggleButton = document.getElementById("theme-toggle");
		const root = document.documentElement;
		const isDark = () => root.classList.contains("dark");
		const savedTheme = localStorage.getItem("theme");

		if (!savedTheme) {
		  const prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
		  root.classList.toggle("dark", prefersDark);
		  localStorage.setItem("theme", prefersDark ? "dark" : "light");
		  if (toggleButton) toggleButton.textContent = prefersDark ? "‚òÄÔ∏è" : "üåô";
		} else {
		  root.classList.toggle("dark", savedTheme === "dark");
		  if (toggleButton) toggleButton.textContent = savedTheme === "dark" ? "‚òÄÔ∏è" : "üåô";
		}

		toggleButton?.addEventListener("click", () => {
		  const next = isDark() ? "light" : "dark";
		  root.classList.toggle("dark", next === "dark");
		  localStorage.setItem("theme", next);
		  toggleButton.textContent = next === "dark" ? "‚òÄÔ∏è" : "üåô";
		});

		// –ü–æ–∏—Å–∫ –Ω–∏–∫–Ω–µ–π–º–∞
		const input = document.getElementById("scroll-nick");
		const datalist = document.getElementById("nicknames");
		input?.addEventListener("input", () => {
		  const val = input.value.trim().toLowerCase();
		  datalist.innerHTML = "";
		  if (val.length >= 2) {
			allNicknames
			  .filter(n => typeof n === "string" && n.toLowerCase().includes(val))
			  .slice(0, 20)
			  .forEach(n => {
				const option = document.createElement("option");
				option.value = n;
				datalist.appendChild(option);
			  });
		  }
		});
	  });
	  
	  // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –≤–∏–¥ –æ–±—â–µ–π —Å—É–º–º—ã/–ø—Ä–∏—Ä–æ—Å—Ç–∞ –ø—Ä–∏ —Ä–∞—Å–∫—Ä—ã—Ç–∏–∏/—Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–∏ details
		document.querySelectorAll('td > details').forEach((d) => {
		  const tr = d.closest('tr');
		  if (!tr) return;
		  const totalInline = tr.querySelector('.total-inline');
		  const totalStacked = tr.querySelector('.total-stacked');
		  if (!totalInline || !totalStacked) return;

		  const sync = () => {
			const open = d.open;
			totalInline.style.display = open ? 'none' : 'inline-block';
			totalStacked.style.display = open ? 'inline-block' : 'none';
		  };
		  d.addEventListener('toggle', sync);
		  // –ø–µ—Ä–≤–∏—á–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è (–Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –∫–∞–∫–∏–µ-—Ç–æ details –æ—Ç–∫—Ä—ã—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
		  sync();
		});
	</script>


<script>
(function () {
  async function fetchLevelPlayers(snapshotId, level, page, pageSize) {
    const url = `/api/level_players?snapshot_id=${encodeURIComponent(snapshotId)}&level=${encodeURIComponent(level)}&page=${encodeURIComponent(page)}&page_size=${encodeURIComponent(pageSize)}`;
    const res = await fetch(url, { headers: { "Accept": "application/json" } });
    if (!res.ok) throw new Error("HTTP " + res.status);
    return await res.json();
  }

  function getTbody(level) {
    return document.getElementById(`lvl-${level}-tbody`);
  }

  async function loadLevel(level, append) {
    const tbody = getTbody(level);
    if (!tbody) return;

    const snapshotId = tbody.dataset.snapshot;
    const pageSize = 100;
    const currentPage = parseInt(tbody.dataset.page || "0", 10);
    const nextPage = append ? (currentPage + 1) : 1;

    const status = document.querySelector(`.load-status[data-level="${level}"]`);
    const btn = document.querySelector(`.load-more-btn[data-level="${level}"]`);

    try {
      if (status) status.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶";
      const data = await fetchLevelPlayers(snapshotId, level, nextPage, pageSize);

      if (!append) {
        tbody.innerHTML = data.rows_html || "";
      } else {
        tbody.insertAdjacentHTML("beforeend", data.rows_html || "");
      }

      tbody.dataset.page = String(nextPage);

      if (btn) {
        btn.style.display = data.has_more ? "inline-block" : "none";
      }
      if (status) status.textContent = data.has_more ? "" : "–ö–æ–Ω–µ—Ü —Å–ø–∏—Å–∫–∞";
    } catch (e) {
      if (status) status.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏";
      console.error(e);
    }
  }

  // Load first page on <details> open
  document.querySelectorAll("details").forEach((d) => {
    d.addEventListener("toggle", () => {
      if (!d.open) return;
      const tbody = d.querySelector("tbody[id^='lvl-'][data-level]");
      if (!tbody) return;
      const level = tbody.dataset.level;
      const page = parseInt(tbody.dataset.page || "0", 10);
      if (page === 0) loadLevel(level, false);
    });
  });

  // Load more
  document.addEventListener("click", (ev) => {
    const btn = ev.target.closest(".load-more-btn");
    if (!btn) return;
    const level = btn.dataset.level;
    loadLevel(level, true);
  });
})();
</script>

</body>
</html>
